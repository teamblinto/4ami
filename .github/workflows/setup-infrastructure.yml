name: Setup AWS Infrastructure

on:
  workflow_dispatch:
    inputs:
      create_database:
        description: 'Create RDS PostgreSQL database'
        required: true
        default: 'true'
        type: boolean

jobs:
  setup-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Create RDS PostgreSQL Database
      if: ${{ github.event.inputs.create_database == 'true' }}
      run: |
        # Check if database already exists
        if aws rds describe-db-instances --db-instance-identifier ami-database --query 'DBInstances[0].DBInstanceStatus' --output text 2>/dev/null | grep -q "available"; then
          echo "âœ… Database already exists and is available"
        else
          echo "ğŸš€ Creating RDS PostgreSQL database..."
          aws rds create-db-instance \
            --db-instance-identifier ami-database \
            --db-instance-class db.t3.micro \
            --engine postgres \
            --engine-version 15.7 \
            --master-username 4ami_admin \
            --master-user-password "${{ secrets.DB_PASSWORD }}" \
            --allocated-storage 20 \
            --vpc-security-group-ids default \
            --publicly-accessible \
            --storage-encrypted \
            --backup-retention-period 7 \
            --multi-az false \
            --auto-minor-version-upgrade
        
          echo "â³ Waiting for database to be available..."
          aws rds wait db-instance-available --db-instance-identifier ami-database
          echo "âœ… Database created successfully!"
        fi

    - name: Get Database Endpoint
      if: ${{ github.event.inputs.create_database == 'true' }}
      run: |
        DB_ENDPOINT=$(aws rds describe-db-instances --db-instance-identifier ami-database --query 'DBInstances[0].Endpoint.Address' --output text)
        echo "DATABASE_ENDPOINT=$DB_ENDPOINT" >> $GITHUB_ENV
        echo "âœ… Database endpoint: $DB_ENDPOINT"

    - name: Create Security Groups
      run: |
        # Create security group for backend
        aws ec2 create-security-group \
          --group-name 4ami-backend-sg \
          --description "Security group for 4ami backend" \
          --vpc-id $(aws ec2 describe-vpcs --query 'Vpcs[0].VpcId' --output text) || echo "Security group may already exist"

        # Create security group for database
        aws ec2 create-security-group \
          --group-name 4ami-db-sg \
          --description "Security group for 4ami database" \
          --vpc-id $(aws ec2 describe-vpcs --query 'Vpcs[0].VpcId' --output text) || echo "Security group may already exist"

    - name: Setup Environment Variables
      run: |
        echo "ğŸ”§ Setting up environment variables..."
        echo "DATABASE_URL=postgresql://4ami_admin:${{ secrets.DB_PASSWORD }}@${{ env.DATABASE_ENDPOINT }}:5432/4ami" >> $GITHUB_ENV
        echo "âœ… Environment variables configured"

    - name: Output Infrastructure Info
      run: |
        echo "ğŸ—ï¸ Infrastructure Setup Complete!"
        echo "ğŸ“Š Database: ami-database"
        echo "ğŸ”— Endpoint: ${{ env.DATABASE_ENDPOINT }}"
        echo "ğŸ” Connection String: ${{ env.DATABASE_URL }}"
